const { redisClient } = require('../config/redis');

exports.createBroadcast = async (req, res) => {
Â  // 1. Check for permission (organizer only)
Â  if (req.user.role !== 'organizer') {
Â  Â  return res.status(403).json({ msg: 'Access denied: Organizers only' });
Â  }

Â  const { title, text } = req.body;
Â  if (!title || !text) {
Â  Â  return res.status(400).json({ msg: 'Title and text are required' });
Â  }

Â  try {
Â  Â  const channel = 'notifications'; // A new channel, just for this!
Â  Â  const message = JSON.stringify({
Â  Â  Â  type: 'BROADCAST_MESSAGE',
Â  Â  Â  payload: {
Â  Â  Â  Â  id: new Date().getTime(), // Simple unique ID
Â  Â  Â  Â  title,
Â  Â  Â  Â  text,
Â  Â  Â  },
Â  Â  });

Â  Â  // 2. Publish the broadcast
Â  Â  await redisClient.publish(channel, message);
Â  Â  console.log(`ðŸš€ [Pub/Sub] PUBLISHED message to '${channel}'`);

Â  Â  res.json({ msg: 'Broadcast message sent successfully' });

Â  } catch (err) {
Â  Â  console.error(err.message);
Â  Â  res.status(500).send('Server Error');
Â  }
};